<!DOCTYPE html>
<html lang="en">

<head>
    <title>Pima Guitars</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="images/toplogo.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="images/toplogo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600,700,800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lora:400,400i,700,700i&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Amatic+SC:400,700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">

    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/owl.theme.default.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">

    <link rel="stylesheet" href="css/aos.css">

    <link rel="stylesheet" href="css/ionicons.min.css">

    <link rel="stylesheet" href="css/bootstrap-datepicker.css">
    <link rel="stylesheet" href="css/jquery.timepicker.css">


    <link rel="stylesheet" href="css/flaticon.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/style.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Site CSS -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="css/responsive.css">
    <!-- Custom CSS -->
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body class="goto-here">

    <!-- End Main Top -->

    <!-- Start Main Top -->
    <header class="main-header">
        <!-- Start Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light navbar-default bootsnav">
            <div class="container">
                <!-- Start Header Navigation -->
                <div class="navbar-header">
                    <a class="navbar-brand" href="#"><img src="images/logo.png" class="logo" alt="" style="display:flex; justify-content:center; align-items:center;"></a>
                </div>

                <!-- End Header Navigation -->

                <!-- Collect the nav links, forms, and other content for toggling -->
                <!-- /.navbar-collapse -->

            </div>
            <!-- Start Side Menu -->
           
        </nav>
        <!-- End Navigation -->
    </header>
    <!-- End Main Top -->


                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="dropdown04" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false"><span class="icon-user"></span></a>
                        <div class="dropdown-menu" aria-labelledby="dropdown04" id="userDropdown">
                        </div>
                    </li>
                    <li class="nav-item"><a href="contact.html" class="nav-link" id="greet"></a></li>

                </ul>
            </div>
        </div>
    </nav>
    <!-- END nav -->

    <div class="hero-wrap hero-bread" style="background-image: url('images/img8.jpg');">
        <div class="container">
            <div class="row no-gutters slider-text align-items-center justify-content-center">
                <div class="col-md-9 ftco-animate text-center">
                    <h1 class="mb-0 bread">Product Management</h1>
                </div>
            </div>
        </div>
    </div>

    <section class="ftco-section contact-section bg-light">
        <div class="container">
            <h1>Got Any New Stuff To Sell?</h1>

            <!-- Button trigger modal -->
            <button type="button" class="btn btn-primary mb-4" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                Add New Product
            </button>

            <!-- Modal -->
            <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
                aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="staticBackdropLabel">Add Product</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form action="" id="productForm">
                                <div class="mb-3 row">
                                    <label for="inputProdName" class="col-sm-2 col-form-label">Product Name</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="inputProdName"
                                            style="height: 40px !important;">
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label for="inputPrice" class="col-sm-2 col-form-label">Price</label>
                                    <div class="col-sm-10">
                                        <input type="number" class="form-control" id="inputPrice"
                                            style="height: 40px !important;">
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label for="inputImage" class="col-sm-2 col-form-label">Image</label>
                                    <div class="col-sm-10">
                                        <input type="file" class="form-control" id="inputImage"
                                            style="height: 40px !important;">
                                    </div>
                                </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <input type="submit" class="btn btn-primary " value="Submit" id="submitProduct"></input>
                        </div>
                        </form>
                    </div>
                </div>
            </div>
            <!-- ---------- Modal End -------------- -->
            <!-- Add this HTML code where you want the product list and edit form to appear -->


            <!-- Modal -->
            <div id="editFormContainer">
                <div class="modal fade" id="updateProduct" data-bs-backdrop="static" data-bs-keyboard="false"
                    tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="staticBackdropLabel">Update Product</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form action="" id="editProductForm">
                                    <div class="mb-3 row">
                                        <label for="editProdName" class="col-sm-2 col-form-label">Product Name</label>
                                        <div class="col-sm-10">
                                            <input type="text" class="form-control" id="editProdName"
                                                style="height: 40px !important;">
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="editPrice" class="col-sm-2 col-form-label">Price</label>
                                        <div class="col-sm-10">
                                            <input type="number" class="form-control" id="editPrice"
                                                style="height: 40px !important;">
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="editImage" class="col-sm-2 col-form-label">Image</label>
                                        <div class="col-sm-10">
                                            <input type="file" class="form-control" id="editImage"
                                                style="height: 40px !important;">
                                        </div>
                                    </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <input type="submit" class="btn btn-primary " value="Submit" id="submitProduct"></input>
                            </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>




            <!-- <div id="editFormContainer" style="display: none;">
        <h2>Edit Product</h2>
        <form id="editProductForm">
          <label for="editProdName">Product Name:</label>
          <input type="text" id="editProdName" required>

          <label for="editPrice">Price:</label>
          <input type="number" id="editPrice" required>

          <label for="editImage">Image:</label>
          <input type="file" id="editImage">

          <button type="submit">Save Changes</button>
        </form>
      </div> -->

            <form action="">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Product ID</th>
                            <th scope="col">Image</th>
                            <th scope="col">Name</th>
                            <th scope="col">Price</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody class="table-group-divider" id="productList">
                        <!-- <tr>
              <th scope="row" class="align-items-center" style="padding: 40px 10px;" id="prodId">1</th>
              <td id="prodImg"></td>
              <td id="prodName">Prod1</td>
              <td id="prodPrice">120</td>
              <td>
                <div class="col">
                  <div class="btn btn-primary">Edit</div>
                  <div class="btn btn-danger">Delete</div>
                </div>
              </td>
            </tr> -->
                    </tbody>
                </table>
            </form>
        </div>
    </section>


    <footer class="ftco-footer ftco-section" style="background-color: whitesmoke;">
        <div class="container">
            <div class="row">
                <div class="mouse">
                    <a href="#" class="mouse-icon">
                        <div class="mouse-wheel"><span class="ion-ios-arrow-up"></span></div>
                    </a>
                </div>
            </div>
            <div class="row mb-5" style="color: black;">
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4">
                        <h2 class="ftco-heading-2">About PIMA Guitars</h2>
                        <p style="text-align: justify;">PIMA offers a wide variety of musical instruments mainly Guitars from which you can choose from. Our products are top-quality and you can rest assured that it will last and will give you the musical experience you desire. PIMA focuses on giving quality service/repairs and quality products.</p>
                        <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-5">
                            <li class="ftco-animate"><a href="#"><span class="icon-twitter"></span></a></li>
                            <li class="ftco-animate"><a href="#"><span class="icon-facebook"></span></a></li>
                            <li class="ftco-animate"><a href="#"><span class="icon-instagram"></span></a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4 ml-md-5">
                        <center><h2 class="ftco-heading-2">Information</h2></center>
                        <ul class="list-unstyled" style="text-align: center;">
                            <li><p><i class="fas fa-search"></i><a href="about.html">About Us</a></p></li>
                            <li><p><i class="fas fa-user"></i><a href="contact-us.html">Customer Service</a></p></li>
                            <li><p><i class="fas fa-shopping-bag"></i><a href="products2.html">Our Gallery</a></p></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md">
                    <div class="ftco-footer-widget mb-4">
                        <h2 class="ftco-heading-2">Contact Us</h2>
                        <div class="block-23 mb-3">
                            <ul>
                                <li><p><i class="fas fa-map-marker-alt"></i>Address: Purok 6 Malangka<br> Legazpi, City</p></li>
                                <li><p><i class="fas fa-phone-square"></i>Phone: <a href="tel:+1-888705770">+63 197 003 195</a></p></li>
                                <li><p><i class="fas fa-envelope"></i>Email: <a href="mailto:pimamusic01@gmail.com">pimamusic01@gmail.com</a></p></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12 text-center" style="background-color: black;">

                    <p style="text-decoration: white;"><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                        Copyright &copy;
                        <script>document.write(new Date().getFullYear());</script> All Rights Reserved. | PIMA Guitars</a>
                        <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    </p>
                </div>
            </div>
        </div>
    </footer>


    <!-- loader -->


    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getDatabase, set, ref, push, update, remove, onValue, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdJ18MNp1wBnGP5YM3penvsjqp8o5wvkM",
            authDomain: "auth-ddcad.firebaseapp.com",
            databaseURL: "https://auth-ddcad-default-rtdb.firebaseio.com",
            projectId: "auth-ddcad",
            storageBucket: "auth-ddcad.appspot.com",
            messagingSenderId: "632550091518",
            appId: "1:632550091518:web:1afe4024d4a13a882653af"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const auth = getAuth(app);
        const storage = getStorage(app); // Initialize Firebase Storage
        const productsRef = ref(db, 'Products');

        // Initialize variables
        let inputProdName = document.getElementById('inputProdName');
        let inputPrice = document.getElementById('inputPrice');
        let inputImage = document.getElementById('inputImage');
        let productForm = document.getElementById('productForm');

        let userCredentials = JSON.parse(sessionStorage.getItem("user-credentials"));
        let userInfo = JSON.parse(sessionStorage.getItem("user-info"));

        let greet = document.getElementById("greet");
        let signOutButton = document.getElementById("sign_out");

        let signOut = () => {
            sessionStorage.removeItem("user-info");
            sessionStorage.removeItem("user-credentials");
            window.location.href = "login.html";
        };

        let userDropdown = document.getElementById("userDropdown");

        let updateDropdownMenu = () => {
            if (userCredentials) {
                userDropdown.innerHTML = `
							<a class="dropdown-item" href="#" id="sign_out">Sign Out</a>`;
                greet.innerHTML = `Welcome ${userInfo.username}!`;
            } else {
                userDropdown.innerHTML = `
							<a class="dropdown-item" href="signup.html" id="sign_up">Sign Up</a>
							<a class="dropdown-item" href="login.html" id="log_in">Log In</a>`;
            }
        };

        let checkCred = () => {
            updateDropdownMenu();
        };

        window.addEventListener('load', checkCred);
        userDropdown.addEventListener('click', (event) => {
            if (event.target.id === 'sign_out') {
                signOut();
            } else if (event.target.id === 'sign_up') {
                window.location.href = 'signup.html';
            } else if (event.target.id === 'log_in') {
                window.location.href = 'Account_As.html';
            }
        });



        // Function to add a product
        let addProduct = evt => {

            evt.preventDefault();

            // Add your product data retrieval logic here
            let productName = inputProdName.value;
            let price = inputPrice.value;
            let image = inputImage.files[0]; // Get the selected file

            // Check if a user is logged in
            
                // Use push to automatically generate a unique ID
                const newProductRef = push(ref(db, 'Products'));

                // Get a reference to the Firebase Storage location
                const storageRef = sRef(storage, 'product_images/' + newProductRef.key + '/' + image.name);

                // Upload the image to Firebase Storage
                uploadBytes(storageRef, image)
                    .then(snapshot => {
                        // Get the download URL of the uploaded image
                        getDownloadURL(snapshot.ref).then((downloadURL) => {
                            // Add the product to the database with a randomized ID and the image URL
                            set(ref(db, 'Products/' + newProductRef.key), {
                                productName: productName,
                                price: price,
                                image: downloadURL // Store the download URL in the database
                            })
                                .then(() => {
                                    alert("Product added successfully");
                                    // Add any additional logic you need after a successful product addition
                                })
                                .catch((error) => {
                                    alert("Error adding product: " + error.message);
                                });
                        });
                    })
                    .catch(error => {
                        alert("Error uploading image: " + error.message);
                    });
        };

        // Trigger the function with the form submission
        productForm.addEventListener('submit', addProduct);

        // Function to render product data in the HTML table
        const renderProductData = (productId, productData) => {
            const productList = document.getElementById('productList');

            const row = document.createElement('tr');
            row.innerHTML = `
    <th scope="row" class="align-items-center" style="padding: 40px 10px;" id="prodId">${productId}</th>
    <td id="prodImg" class="editable"><img src="${productData.image}" alt="Product Image" style="max-width: 100px;"></td>
    <td class="editable" id="prodName">${productData.productName}</td>
    <td class="editable" id="prodPrice">${productData.price}</td>
    <td>
      <div class="col">
        <div class="btn btn-primary edit-btn" data-product-id="${productId}" data-bs-toggle="modal" data-bs-target="#updateProduct">Edit</div>
        <div class="btn btn-danger delete-btn" data-product-id="${productId}">Delete</div>
      </div>
    </td>
  `;

            productList.appendChild(row);

            // Add event listeners for edit and delete buttons
            const editBtn = row.querySelector('.edit-btn');
            const deleteBtn = row.querySelector('.delete-btn');

            editBtn.addEventListener('click', () => handleEditProduct(productId, row));
            deleteBtn.addEventListener('click', () => handleDeleteProduct(productId, row));
        };

        // Function to handle edit button click
        const handleEditProduct = (productId, row) => {
            const editFormContainer = document.getElementById('editFormContainer');
            const editProdName = document.getElementById('editProdName');
            const editPrice = document.getElementById('editPrice');
            const editImage = document.getElementById('editImage');
            const editProductForm = document.getElementById('editProductForm');

            // Retrieve existing product data
            const productRef = ref(db, `Products/${productId}`);
            onValue(productRef, (snapshot) => {
                const productData = snapshot.val();

                // Populate the edit form with existing data
                editProdName.value = productData.productName;
                editPrice.value = productData.price;

                // Set the product ID as a data attribute for the form
                editProductForm.setAttribute('data-product-id', productId);

                // Display the edit form
                editFormContainer.style.display = 'block';
            });
        };

        // Optimized function to handle delete product and remove the entire row
        const handleDeleteProduct = (productId, row) => {
            if (confirm("Are you sure you want to delete this product?")) {
                const productRef = ref(db, `Products/${productId}`);

                // Delete the product data from the database
                remove(productRef)
                    .then(() => {
                        alert("Product deleted successfully");
                        // Remove the corresponding row from the HTML table
                        row.remove();
                    })
                    .catch((error) => {
                        alert("Error deleting product: " + error.message);
                    });
            }
        };

        // Function to handle form submission for editing
        const editProductForm = document.getElementById('editProductForm');
        editProductForm.addEventListener('submit', async (evt) => {
            evt.preventDefault();

            // Get the selected image file
            const newImage = editImage.files[0];
            const productId = editProductForm.getAttribute('data-product-id');

            // Retrieve existing product data
            const productRef = ref(db, `Products/${productId}`);
            const snapshot = await get(productRef);
            const productData = snapshot.val();

            // Check if a new image is selected
            if (newImage) {
                // Get a reference to the Firebase Storage location for the new image
                const storageRef = sRef(storage, `product_images/${productId}/${newImage.name}`);

                try {
                    // Upload the new image to Firebase Storage
                    await uploadBytes(storageRef, newImage);

                    // Get the download URL of the uploaded image
                    const downloadURL = await getDownloadURL(storageRef);

                    // Update product data with the new image URL
                    await update(productRef, {
                        productName: editProdName.value,
                        price: editPrice.value,
                        image: downloadURL,
                    });

                    alert('Product updated successfully with a new image');
                } catch (error) {
                    alert('Error updating product image: ' + error.message);
                }
            } else {
                // Update product data without changing the image
                try {
                    await update(productRef, {
                        productName: editProdName.value,
                        price: editPrice.value,
                    });
                    alert("Edit successful");
                } catch (error) {
                    alert('Error updating product: ' + error.message);
                }
            }

            // Hide the edit form
            // editFormContainer.style.display = 'none';
        });

        // Function to retrieve product data from Firebase
        const fetchProductData = () => {
            // Listen for changes in the products node
            onValue(productsRef, (snapshot) => {
                const products = snapshot.val();

                // Clear the existing table rows
                document.getElementById('productList').innerHTML = '';

                // Iterate through each product and render it in the table
                for (const productId in products) {
                    renderProductData(productId, products[productId]);
                }
            });
        };


        // Trigger the function to fetch and display product data
        window.addEventListener('load', () => {

            fetchProductData();
        });


    </script>



    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-migrate-3.0.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/aos.js"></script>
    <script src="js/jquery.animateNumber.min.js"></script>
    <script src="js/bootstrap-datepicker.js"></script>
    <script src="js/scrollax.min.js"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVWaKrjvy3MaE7SQ74_uJiULgl1JY0H2s&sensor=false"></script>
    <script src="js/google-map.js"></script>
    <script src="js/main.js"></script>

</body>

</html>